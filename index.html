<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Define la codificaci칩n de caracteres como UTF-8 -->
    <meta charset="UTF-8">
    <!-- Hace que la p치gina sea responsive  -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- T칤tulo que aparece en la pesta침a del navegador -->
    <title>Geoportal AO</title>
    <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
    <!-- Fuente Montserrat desde Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet">
    <!-- Hoja de estilos de Leaflet (mapas interactivos) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Hoja de estilos de Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous">
    <!-- Iconos de Bootstrap  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <!-- Hoja de estilos personalizada del proyecto -->
    <link rel="stylesheet" href="style.css?v=9">
    <!-- Estilos extra para el bot칩n de consulta en el sidebar -->
    <style>
      /* Mantener la estructura de la barra lateral */
      .sidebar-footer {
        margin-top: 20px;
      }
      
      /* Actualizamos el bot칩n de "Consulta otros mapas"                */
      #consultaMapasBtn {
        padding: 10px;
        background-color: #922B21;
        border: none;
        color: #fff;
        font-family: 'Montserrat', sans-serif;
        cursor: pointer;
        width: 100%;
        border-radius: 4px;
        transition: background-color 0.3s ease;
      }
      
      #consultaMapasBtn:hover {
        background-color: #7a1f1a;
      }
      
      /* Estilos para las pesta침as del modal de estad칤sticas */
      #estadisticasTabs .nav-link {
        color: #000 !important;
        font-weight: 500;
        border: 1px solid #dee2e6;
      }
      
      #estadisticasTabs .nav-link:hover {
        color: #000 !important;
        background-color: #f8f9fa;
      }
      
      #estadisticasTabs .nav-link.active {
        color: #000 !important;
        font-weight: 600;
        background-color: #fff !important;
        border-bottom-color: #fff !important;
      }
    </style>
  </head>

  <body>
    <!-- Mensaje de rotaci칩n para dispositivos m칩viles -->
    <div id="rotation-message">
        <div class="rotation-icon">游님</div>
        <h2>Gira tu dispositivo</h2>
        <p>Para una mejor experiencia, por favor gira tu dispositivo a modo horizontal (landscape)</p>
    </div>

    <!-- Modal para mostrar estad칤sticas -->
    <div class="modal fade" id="estadisticasModal" tabindex="-1" aria-labelledby="estadisticasModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="estadisticasModalLabel">Estad칤sticas</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Pesta침as de navegaci칩n -->
            <ul class="nav nav-tabs" id="estadisticasTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos" type="button" role="tab" aria-controls="datos" aria-selected="true">Estad칤sticas</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="copacos-tab" data-bs-toggle="tab" data-bs-target="#copacos" type="button" role="tab" aria-controls="copacos" aria-selected="false">Conoce a tus COPACOS</button>
              </li>
            </ul>
            <!-- Contenido de las pesta침as -->
            <div class="tab-content" id="estadisticasTabContent" style="margin-top: 15px;">
              <!-- Pesta침a de Estad칤sticas -->
              <div class="tab-pane fade show active" id="datos" role="tabpanel" aria-labelledby="datos-tab">
                <div id="estadisticasInfo"></div>
                <div style="margin-top: 15px;">
                  <canvas id="piramidePoblacional" style="max-height: 300px;"></canvas>
                </div>
              </div>
              <!-- Pesta침a de COPACOS -->
              <div class="tab-pane fade" id="copacos" role="tabpanel" aria-labelledby="copacos-tab">
                <div id="copacosInfo" style="padding: 10px;">
                  <p class="text-muted">Cargando informaci칩n de COPACOS...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <p class="small mb-0">
              Fuente de datos:
              <a href="https://www.inegi.org.mx/programas/ccpv/2020/" target="_blank" rel="noopener noreferrer">
                Censo Poblacional y Vivienda 2020 INEGI
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para mostrar fotos -->
    <div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="fotoModalLabel">Galer칤a de Fotograf칤as</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Carrusel de im치genes -->
            <div id="carouselFotos" class="carousel slide" data-bs-ride="false">
              <div class="carousel-inner" id="carouselInner">
                <!-- Las im치genes se cargar치n din치micamente aqu칤 -->
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#carouselFotos" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselFotos" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Siguiente</span>
              </button>
            </div>
            <!-- Contador de im치genes -->
            <div class="text-center mt-3">
              <span id="contadorFotos" class="badge bg-secondary"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor general que abarca panel lateral y mapa -->
    <div class="main-container">
      <!-- Contenedor lateral (panel + bot칩n) -->
      <div class="sidebar-container" id="sidebarContainer">
        <!-- Panel de informaci칩n -->
        <div class="informacion" id="sidebar">
          <div class="contenido-informacion">
            <!-- Campo de b칰squeda de Colonias -->
            <div class="form">
              <label class="label_buscar_colonia" for="floatingInput">Buscador</label>
              <input type="text" class="form-control" id="floatingInput" placeholder="Escribir Colonia, Sitio o Actividad">
              <div id="suggestions" class="suggestions"></div>
              <button id="btnLimpiarBusqueda" class="btn-limpiar-busqueda">Limpiar</button>
            </div>
          </div>
          <!-- Contenedor donde se agregar치n din치micamente los controles de capas -->
          <div id="controlCapasContainer" class="control-capas-panel">
            <!-- Checkbox para la capa de Colonias, palomeado inicialmente -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleColoniasCheckbox" checked disabled>
              <label class="form-check-label" for="toggleColoniasCheckbox">
                Colonias
              </label>
            </div>
            <!-- Checkbox para la capa de Poblaci칩n -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="togglePoblacionCheckbox" disabled>
              <label class="form-check-label" for="togglePoblacionCheckbox">
                Poblaci칩n
              </label>
            </div>
            <!-- Checkbox para la capa IDS_AO -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleIDSCheckbox" disabled>
              <label class="form-check-label" for="toggleIDSCheckbox">
                칈ndice de Desarrollo Social
              </label>
            </div>
            <!-- Checkbox para la capa de Unidades Habitacionales -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleUHabitacionalesCheckbox" disabled>
              <label class="form-check-label" for="toggleUHabitacionalesCheckbox">
                Unidades Habitacionales
              </label>
            </div>
            <!-- Checkbox para la capa de Casas Obregonenses -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleCasasOCheckbox" disabled>
              <label class="form-check-label" for="toggleCasasOCheckbox">
                Casas Obregonenses
              </label>
            </div>
            <!-- Checkbox para la capa de Cl칰ster Universitario -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="toggleClusterCheckbox" disabled>
              <label class="form-check-label" for="toggleClusterCheckbox">
                Cl칰ster Universitario
              </label>
            </div>
          </div>
          <!-- Bot칩n ubicado en la parte inferior de la barra lateral -->
          <div class="sidebar-footer">
            <button id="consultaMapasBtn">Consulta la Mapoteca digital</button>
          </div>
        </div>
      </div>
      
      <!-- Bot칩n toggle en el borde del sidebar -->
      <button class="toggle-btn" id="toggleBtn">
        <span class="hamburger"></span>
      </button>
      
      <!-- Mapa  -->
      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <!-- SCRIPTS EXTERNOS -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Bootstrap JS: Biblioteca para componentes UI -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <!-- Chart.js: Biblioteca para generar gr치ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script que controla la visualizaci칩n y l칩gica de las estad칤sticas en el modal -->
    <script src="estadisticas.js?v=11"></script>
    <!-- Script que controla la actualizaci칩n de las capas cada 10 segundos -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- CONSULTA DE L칍GICA JAVASCRIPT -->

    <!-- Script que inicializa el mapa base -->
    <script src="mapabase.js?v=8"></script>
    <!-- Script que define y carga la capa de Colonias en el mapa -->
    <script src="Capa_Colonia.js?v=7"></script>
    <!-- Script para incorporar capa de Poblaci칩n -->
    <script src="Capa_Poblacion.js?v=5"></script>
    <!-- Script para incorporar capa de pol칤gonos (IDS_AO) -->
    <script src="Capa_pol.js?v=3"></script>
    <!-- Script para incorporar capa de Unidades Habitacionales -->
    <script src="Capa_u_habitacionales.js?v=1"></script>
    <!-- Script para incorporar capa de Casas Obregonenses -->
    <script src="Capa_casas_o.js?v=1"></script>
    <!-- Script para incorporar capa de Cl칰ster Universitario -->
    <script src="Capa_cluster.js?v=1"></script>
    <!-- Script que maneja la l칩gica del buscador de colonias -->
    <script src="buscador.js?v=7"></script>
    <!-- Script donde se definen las capas tem치ticas, info a mostrar e 칤conos -->
    <script src="capas.js?v=8"></script>
    <!-- Script principal que contiene l칩gica de men칰 lateral -->
    <script src="script.js?v=2"></script>

    <!-- Script para el control de los checkboxes de capas -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Control para la capa de Colonias
        var toggleColoniasCheckbox = document.getElementById("toggleColoniasCheckbox");
        if (toggleColoniasCheckbox) {
          toggleColoniasCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (window.capaColonias) {
                map.addLayer(window.capaColonias);
              }
            } else {
              if (window.capaColonias) {
                map.removeLayer(window.capaColonias);
              }
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para encender/apagar la capa de Colonias.");
        }

        // Control para la capa de Poblaci칩n
        var togglePoblacionCheckbox = document.getElementById("togglePoblacionCheckbox");
        if (togglePoblacionCheckbox) {
          togglePoblacionCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (window.capaPoblacion) {
                map.addLayer(window.capaPoblacion);
                window.capaPoblacion.eachLayer(layer => layer.bringToBack());
              }
            } else {
              if (window.capaPoblacion) {
                map.removeLayer(window.capaPoblacion);
              }
            }
            // Actualizar simbolog칤a
            if (typeof window.actualizarSimbologia === 'function') {
              window.actualizarSimbologia();
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para encender/apagar la capa de Poblaci칩n.");
        }

        // Control para la capa IDS_AO
        var toggleCheckbox = document.getElementById("toggleIDSCheckbox");
        if (toggleCheckbox) {
          toggleCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (IDS_AO_layer && map.geojsonBaseLayerGroup) {
                map.geojsonBaseLayerGroup.addLayer(IDS_AO_layer);
                IDS_AO_layer.eachLayer(layer => layer.bringToBack());
              }
            } else {
              if (IDS_AO_layer && map.geojsonBaseLayerGroup) {
                map.geojsonBaseLayerGroup.removeLayer(IDS_AO_layer);
              }
            }
            // Actualizar simbolog칤a
            if (typeof window.actualizarSimbologia === 'function') {
              window.actualizarSimbologia();
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para la capa IDS.");
        }

        // Control para la capa de Unidades Habitacionales
        var toggleUHCheckbox = document.getElementById("toggleUHabitacionalesCheckbox");
        if (toggleUHCheckbox) {
          toggleUHCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (window.U_Habitacionales_layer) {
                window.U_Habitacionales_layer.addTo(map);
                window.U_Habitacionales_layer.eachLayer(layer => layer.bringToBack());
              }
            } else {
              if (window.U_Habitacionales_layer) {
                map.removeLayer(window.U_Habitacionales_layer);
              }
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para encender/apagar la capa de Unidades Habitacionales.");
        }

        // Control para la capa de Casas Obregonenses
        var toggleCasasOCheckbox = document.getElementById("toggleCasasOCheckbox");
        if (toggleCasasOCheckbox) {
          toggleCasasOCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (window.Casas_O_layer) {
                window.Casas_O_layer.addTo(map);
                window.Casas_O_layer.eachLayer(layer => layer.bringToBack());
              }
            } else {
              if (window.Casas_O_layer) {
                map.removeLayer(window.Casas_O_layer);
              }
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para encender/apagar la capa de Casas Obregonenses.");
        }

        // Control para la capa de Cl칰ster Universitario
        var toggleClusterCheckbox = document.getElementById("toggleClusterCheckbox");
        if (toggleClusterCheckbox) {
          toggleClusterCheckbox.addEventListener("change", function() {
            if (this.checked) {
              if (window.Cluster_layer) {
                window.Cluster_layer.addTo(map);
              }
            } else {
              if (window.Cluster_layer) {
                map.removeLayer(window.Cluster_layer);
              }
            }
          });
        } else {
          console.error("No se encontr칩 el checkbox para encender/apagar la capa de Cl칰ster Universitario.");
        }

        // Agregar evento al bot칩n "Consulta otros mapas"
        var consultaMapasBtn = document.getElementById("consultaMapasBtn");
        if (consultaMapasBtn) {
          consultaMapasBtn.addEventListener("click", function() {
           window.open(
              "https://drive.google.com/file/d/1qlX5IhZBskU-7atSn5a989xtCiRhkof9/view?usp=sharing",
              "_blank"
           );
          });
        }
      });

      // Funci칩n global para abrir el modal de fotos con carrusel o visor de carpeta
      window.abrirFotoModal = function(urlFotos) {
        console.log('URL(s) de fotos recibida(s):', urlFotos);
        
        // Si no hay URL, no hacer nada
        if (!urlFotos || urlFotos.trim() === '') {
          console.warn('No se proporcionaron URLs de fotos');
          return;
        }
        
        // Detectar si es una carpeta de Google Drive
        var esCarpeta = urlFotos.includes('/folders/');
        
        // Obtener el contenedor del carrusel
        var carouselInner = document.getElementById('carouselInner');
        var contadorFotos = document.getElementById('contadorFotos');
        
        // Limpiar el carrusel
        carouselInner.innerHTML = '';
        
        if (esCarpeta) {
          // CASO 1: Es una carpeta de Google Drive - Mostrar iframe
          console.log('Carpeta de Google Drive detectada');
          
          // Extraer el ID de la carpeta
          var matchFolder = urlFotos.match(/\/folders\/([a-zA-Z0-9_-]+)/);
          if (matchFolder && matchFolder[1]) {
            var folderId = matchFolder[1];
            
            // Crear URL para vista embebida de carpeta
            var urlEmbebida = 'https://drive.google.com/embeddedfolderview?id=' + folderId + '#grid';
            
            // Crear un item del carrusel con iframe
            var item = document.createElement('div');
            item.className = 'carousel-item active';
            
            var iframe = document.createElement('iframe');
            iframe.src = urlEmbebida;
            iframe.style.width = '100%';
            iframe.style.height = '70vh';
            iframe.style.border = 'none';
            iframe.allow = 'autoplay';
            
            item.appendChild(iframe);
            carouselInner.appendChild(item);
            
            // Ocultar controles del carrusel
            var controles = document.querySelectorAll('#carouselFotos .carousel-control-prev, #carouselFotos .carousel-control-next');
            controles.forEach(function(control) {
              control.style.display = 'none';
            });
            
            // Actualizar contador
            contadorFotos.innerHTML = '<i class="bi bi-folder2-open"></i> Carpeta de fotograf칤as';
          }
        } else {
          // CASO 2: URLs individuales - Mostrar carrusel
          console.log('URLs individuales detectadas');
          
          // Separar las URLs por punto y coma o coma
          var urls = urlFotos.split(/[;,]/).map(function(url) { return url.trim(); }).filter(function(url) { return url !== ''; });
          
          console.log('URLs procesadas:', urls);
          
          // Funci칩n para convertir URLs de Google Drive
          function convertirUrlGoogleDrive(url) {
            if (url.includes('drive.google.com')) {
              // Si es un enlace de archivo individual
              var matchFile = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
              if (matchFile && matchFile[1]) {
                return 'https://drive.google.com/uc?export=view&id=' + matchFile[1];
              }
            }
            return url;
          }
          
          // Crear los items del carrusel
          urls.forEach(function(url, index) {
            var urlProcesada = convertirUrlGoogleDrive(url);
            
            if (urlProcesada) {
              var item = document.createElement('div');
              item.className = 'carousel-item' + (index === 0 ? ' active' : '');
              
              var img = document.createElement('img');
              img.src = urlProcesada;
              img.className = 'd-block w-100';
              img.alt = 'Fotograf칤a ' + (index + 1);
              img.style.maxHeight = '70vh';
              img.style.objectFit = 'contain';
              img.style.backgroundColor = '#000';
              
              // Manejar error de carga
              img.onerror = function() {
                console.error('Error cargando imagen:', urlProcesada);
                this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="600"%3E%3Crect fill="%23ddd" width="800" height="600"/%3E%3Ctext fill="%23999" font-family="sans-serif" font-size="24" dy="10.5" font-weight="bold" x="50%25" y="50%25" text-anchor="middle"%3EError al cargar imagen%3C/text%3E%3C/svg%3E';
              };
              
              item.appendChild(img);
              carouselInner.appendChild(item);
            }
          });
          
          // Actualizar contador
          contadorFotos.textContent = urls.length > 1 ? urls.length + ' fotograf칤as' : '1 fotograf칤a';
          
          // Mostrar/ocultar controles del carrusel seg칰n la cantidad de im치genes
          var controles = document.querySelectorAll('#carouselFotos .carousel-control-prev, #carouselFotos .carousel-control-next');
          controles.forEach(function(control) {
            control.style.display = urls.length > 1 ? 'flex' : 'none';
          });
        }
        
        // Mostrar el modal
        var fotoModal = new bootstrap.Modal(document.getElementById('fotoModal'));
        fotoModal.show();
      };
    </script>
  </body>
</html>